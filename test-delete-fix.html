<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Corre√ß√£o do Bot√£o Delete</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 0.9rem;
        }
        .btn:hover {
            background: #2ea043;
        }
        .btn-danger {
            background: #da3633;
        }
        .btn-danger:hover {
            background: #f85149;
        }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
        }
        .schedule-item {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .schedule-actions {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .action-btn:hover {
            background: #30363d;
        }
        .action-btn.delete {
            color: #f85149;
        }
        .action-btn.delete:hover {
            background: #da3633;
            color: white;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }
        .status.success {
            background: #0c2d6b;
            color: #58a6ff;
            border: 1px solid #1f6feb;
        }
        .status.error {
            background: #da3633;
            color: #ff7b72;
            border: 1px solid #f85149;
        }
        .status.info {
            background: #1c1f23;
            color: #8b949e;
            border: 1px solid #30363d;
        }
        .log {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-result {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 1rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Corre√ß√£o do Bot√£o Delete</h1>
        
        <div class="test-section">
            <h3>üìä Status do Sistema</h3>
            <div id="systemStatus"></div>
        </div>

        <div class="test-section">
            <h3>üîß Controles de Teste</h3>
            <button class="btn" onclick="createTestData()">üìù Criar Dados de Teste</button>
            <button class="btn btn-secondary" onclick="clearTestData()">üóëÔ∏è Limpar Dados</button>
            <button class="btn" onclick="loadAndDisplay()">üîÑ Carregar e Exibir</button>
            <button class="btn btn-secondary" onclick="testDeleteFunction()">üß™ Testar Delete</button>
            <button class="btn btn-secondary" onclick="clearLog()">üìã Limpar Log</button>
            <a href="agendamentos.html" class="btn btn-secondary">üìÖ Ir para Agendamentos</a>
        </div>

        <div class="test-section">
            <h3>üìÖ Agendamentos de Teste</h3>
            <div id="schedulesDisplay">
                <!-- Agendamentos ser√£o exibidos aqui -->
            </div>
        </div>

        <div class="test-section">
            <h3>üìã Log de Opera√ß√µes</h3>
            <div id="logOutput" class="log"></div>
        </div>

        <div class="test-section">
            <h3>‚úÖ Resultados dos Testes</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        let schedules = [];
        let logOutput = [];
        let testResults = [];

        // Fun√ß√£o para adicionar log
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logOutput.push(logEntry);
            
            const logElement = document.getElementById('logOutput');
            if (logElement) {
                logElement.textContent = logOutput.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Fun√ß√£o para adicionar resultado de teste
        function addTestResult(testName, success, details = '') {
            const result = {
                name: testName,
                success: success,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            };
            testResults.push(result);
            updateTestResultsDisplay();
        }

        // Atualizar exibi√ß√£o dos resultados
        function updateTestResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            if (!resultsDiv) return;

            const resultsHTML = testResults.map(result => `
                <div class="test-result">
                    <div class="status ${result.success ? 'success' : 'error'}">
                        ${result.success ? '‚úÖ' : '‚ùå'} ${result.name}
                    </div>
                    <div style="font-size: 0.8rem; color: #8b949e; margin-top: 0.5rem;">
                        ${result.details} (${result.timestamp})
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = resultsHTML;
        }

        // Verificar status do sistema
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            const sessionManager = window.sessionManager;
            const currentUser = sessionManager ? sessionManager.getCurrentUser() : null;
            
            let statusHTML = '';
            statusHTML += `<div class="status ${sessionManager ? 'success' : 'error'}">`;
            statusHTML += `${sessionManager ? '‚úÖ' : '‚ùå'} SessionManager: ${sessionManager ? 'Dispon√≠vel' : 'N√£o encontrado'}`;
            statusHTML += '</div>';
            
            if (currentUser) {
                statusHTML += `<div class="status success">`;
                statusHTML += `üë§ Usu√°rio: ${currentUser.name} (ID: ${currentUser.id})`;
                statusHTML += '</div>';
            } else {
                statusHTML += `<div class="status info">`;
                statusHTML += `üë§ Usu√°rio: Nenhum usu√°rio logado`;
                statusHTML += '</div>';
            }
            
            statusDiv.innerHTML = statusHTML;
        }

        // Criar dados de teste
        function createTestData() {
            addLog('üìù Criando dados de teste...');
            
            const testSchedules = [
                {
                    id: 'test_delete_1_' + Date.now(),
                    title: 'Medita√ß√£o Teste 1',
                    time: '08:00',
                    category: 'Salmos',
                    days: ['seg', 'qua', 'sex'],
                    notifications: true,
                    date: new Date().toISOString().split('T')[0],
                    duration: 15,
                    status: 'agendado',
                    createdAt: new Date().toISOString(),
                    description: 'Agendamento de teste 1',
                    userId: 'test_user',
                    userName: 'Usu√°rio Teste'
                },
                {
                    id: 'test_delete_2_' + Date.now(),
                    title: 'Medita√ß√£o Teste 2',
                    time: '12:00',
                    category: 'Jaculat√≥rias',
                    days: ['ter', 'qui'],
                    notifications: false,
                    date: new Date().toISOString().split('T')[0],
                    duration: 10,
                    status: 'agendado',
                    createdAt: new Date().toISOString(),
                    description: 'Agendamento de teste 2',
                    userId: 'test_user',
                    userName: 'Usu√°rio Teste'
                },
                {
                    id: 'test_delete_3_' + Date.now(),
                    title: 'Medita√ß√£o Teste 3',
                    time: '18:00',
                    category: 'Evangelho',
                    days: ['dom'],
                    notifications: true,
                    date: new Date().toISOString().split('T')[0],
                    duration: 20,
                    status: 'agendado',
                    createdAt: new Date().toISOString(),
                    description: 'Agendamento de teste 3',
                    userId: 'test_user',
                    userName: 'Usu√°rio Teste'
                }
            ];

            localStorage.setItem('user_schedules', JSON.stringify(testSchedules));
            addLog(`‚úÖ ${testSchedules.length} agendamentos de teste criados`);
            addTestResult('Cria√ß√£o de Dados', true, `${testSchedules.length} agendamentos criados`);
            
            loadAndDisplay();
        }

        // Limpar dados de teste
        function clearTestData() {
            localStorage.removeItem('user_schedules');
            schedules = [];
            addLog('üóëÔ∏è Dados de teste removidos');
            addTestResult('Limpeza de Dados', true, 'Dados removidos com sucesso');
            loadAndDisplay();
        }

        // Carregar e exibir dados
        function loadAndDisplay() {
            try {
                const allSchedules = JSON.parse(localStorage.getItem('user_schedules') || '[]');
                const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : null;
                const userId = currentUser ? currentUser.id : 'test_user';
                
                schedules = allSchedules.filter(schedule => schedule.userId === userId);
                
                addLog(`üìÖ Carregados ${schedules.length} agendamentos para usu√°rio ${userId}`);
                displaySchedules();
                addTestResult('Carregamento de Dados', true, `${schedules.length} agendamentos carregados`);
                
            } catch (error) {
                addLog(`‚ùå Erro ao carregar dados: ${error.message}`, 'error');
                addTestResult('Carregamento de Dados', false, error.message);
            }
        }

        // Exibir agendamentos
        function displaySchedules() {
            const displayDiv = document.getElementById('schedulesDisplay');
            
            if (schedules.length === 0) {
                displayDiv.innerHTML = `
                    <div class="status info">
                        üìÖ Nenhum agendamento encontrado
                    </div>
                `;
                return;
            }

            const schedulesHTML = schedules.map(schedule => `
                <div class="schedule-item" data-schedule-id="${schedule.id}">
                    <div class="schedule-info">
                        <span>üïê ${schedule.time}</span>
                        <span>üìñ ${schedule.category}</span>
                        <span>üìÖ ${schedule.days.join(', ')}</span>
                        <span>üë§ ${schedule.userName}</span>
                    </div>
                    <div class="schedule-actions">
                        <button class="action-btn" onclick="editSchedule('${schedule.id}')">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="deleteSchedule('${schedule.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            displayDiv.innerHTML = schedulesHTML;
            addLog(`‚úÖ ${schedules.length} agendamentos exibidos`);
        }

        // Fun√ß√£o de delete testada
        function deleteSchedule(scheduleId) {
            addLog(`üóëÔ∏è === IN√çCIO DA EXCLUS√ÉO ===`);
            addLog(`üóëÔ∏è ID recebido: ${scheduleId} (Tipo: ${typeof scheduleId})`);
            addLog(`üìã Total de agendamentos antes: ${schedules.length}`);
            
            if (!scheduleId) {
                addLog(`‚ùå ID do agendamento √© inv√°lido: ${scheduleId}`, 'error');
                addTestResult('Valida√ß√£o de ID', false, 'ID inv√°lido');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                try {
                    const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : null;
                    const userId = currentUser ? currentUser.id : 'test_user';
                    
                    addLog(`üë§ Usu√°rio atual: ${currentUser ? currentUser.name : 'N/A'} (ID: ${userId})`);
                    
                    const scheduleIdStr = String(scheduleId);
                    addLog(`üîÑ ID convertido para string: ${scheduleIdStr}`);
                    
                    const scheduleExists = schedules.some(s => String(s.id) === scheduleIdStr);
                    addLog(`üîç Agendamento existe? ${scheduleExists}`);
                    
                    if (!scheduleExists) {
                        addLog(`‚ùå Agendamento n√£o encontrado no array local`, 'error');
                        addTestResult('Verifica√ß√£o de Exist√™ncia', false, 'Agendamento n√£o encontrado');
                        return;
                    }
                    
                    const originalLength = schedules.length;
                    const filteredSchedules = schedules.filter(s => String(s.id) !== scheduleIdStr);
                    schedules = filteredSchedules;
                    
                    const removed = originalLength - schedules.length;
                    addLog(`üîç Resultado da filtragem: ${originalLength} ‚Üí ${schedules.length} (removidos: ${removed})`);
                    
                    if (removed !== 1) {
                        addLog(`‚ùå Erro na filtragem: n√∫mero incorreto de itens removidos`, 'error');
                        addTestResult('Filtragem', false, `Removidos ${removed} itens (esperado: 1)`);
                        return;
                    }
                    
                    const allSchedules = JSON.parse(localStorage.getItem('user_schedules') || '[]');
                    addLog(`üíæ Total de agendamentos no localStorage: ${allSchedules.length}`);
                    
                    const otherUsersSchedules = allSchedules.filter(schedule => schedule.userId !== userId);
                    const updatedAllSchedules = [...otherUsersSchedules, ...schedules];
                    
                    localStorage.setItem('user_schedules', JSON.stringify(updatedAllSchedules));
                    addLog(`‚úÖ localStorage atualizado. Total final: ${updatedAllSchedules.length}`);
                    
                    displaySchedules();
                    
                    addLog(`‚úÖ === EXCLUS√ÉO CONCLU√çDA COM SUCESSO ===`);
                    addTestResult('Exclus√£o Completa', true, `Agendamento ${scheduleId} removido com sucesso`);
                    
                } catch (error) {
                    addLog(`‚ùå Erro durante a exclus√£o: ${error.message}`, 'error');
                    addTestResult('Exclus√£o', false, error.message);
                }
            } else {
                addLog(`‚ùå Exclus√£o cancelada pelo usu√°rio`);
                addTestResult('Confirma√ß√£o do Usu√°rio', false, 'Usu√°rio cancelou a exclus√£o');
            }
        }

        // Fun√ß√£o de edi√ß√£o (simulada)
        function editSchedule(scheduleId) {
            addLog(`‚úèÔ∏è Fun√ß√£o de edi√ß√£o chamada para: ${scheduleId}`);
            alert(`Fun√ß√£o de edi√ß√£o para agendamento: ${scheduleId}`);
        }

        // Testar fun√ß√£o de delete
        function testDeleteFunction() {
            addLog('üß™ Testando fun√ß√£o de delete...');
            
            if (schedules.length === 0) {
                addLog('‚ö†Ô∏è Nenhum agendamento para testar', 'error');
                addTestResult('Teste de Delete', false, 'Nenhum agendamento dispon√≠vel');
                return;
            }
            
            const testSchedule = schedules[0];
            addLog(`üß™ Testando exclus√£o do agendamento: ${testSchedule.title} (ID: ${testSchedule.id})`);
            
            // Simular exclus√£o sem confirma√ß√£o
            const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : null;
            const userId = currentUser ? currentUser.id : 'test_user';
            
            const allSchedules = JSON.parse(localStorage.getItem('user_schedules') || '[]');
            const otherUsersSchedules = allSchedules.filter(schedule => schedule.userId !== userId);
            
            const updatedSchedules = schedules.filter(s => s.id !== testSchedule.id);
            const updatedAllSchedules = [...otherUsersSchedules, ...updatedSchedules];
            
            localStorage.setItem('user_schedules', JSON.stringify(updatedAllSchedules));
            schedules = updatedSchedules;
            
            addLog(`‚úÖ Teste de exclus√£o conclu√≠do. Agendamentos restantes: ${schedules.length}`);
            displaySchedules();
            addTestResult('Teste Autom√°tico', true, `Agendamento ${testSchedule.id} removido automaticamente`);
        }

        // Limpar log
        function clearLog() {
            logOutput = [];
            testResults = [];
            document.getElementById('logOutput').textContent = '';
            updateTestResultsDisplay();
            addLog('üìã Log limpo');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ P√°gina de teste carregada');
            checkSystemStatus();
            loadAndDisplay();
        });
    </script>
</body>
</html> 