<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - CorreÃ§Ã£o do BotÃ£o Delete</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 0.9rem;
        }
        .btn:hover {
            background: #2ea043;
        }
        .btn-danger {
            background: #da3633;
        }
        .btn-danger:hover {
            background: #f85149;
        }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
        }
        .schedule-item {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .schedule-actions {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .action-btn:hover {
            background: #30363d;
        }
        .action-btn.delete {
            color: #f85149;
        }
        .action-btn.delete:hover {
            background: #da3633;
            color: white;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }
        .status.success {
            background: #0c2d6b;
            color: #58a6ff;
            border: 1px solid #1f6feb;
        }
        .status.error {
            background: #da3633;
            color: #ff7b72;
            border: 1px solid #f85149;
        }
        .status.info {
            background: #1c1f23;
            color: #8b949e;
            border: 1px solid #30363d;
        }
        .log {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .test-result {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 1rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Teste - CorreÃ§Ã£o do BotÃ£o Delete</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š Status do Sistema</h3>
            <div id="systemStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ Controles de Teste</h3>
            <button class="btn" onclick="createTestData()">ğŸ“ Criar Dados de Teste</button>
            <button class="btn btn-secondary" onclick="clearTestData()">ğŸ—‘ï¸ Limpar Dados</button>
            <button class="btn" onclick="loadAndDisplay()">ğŸ”„ Carregar e Exibir</button>
            <button class="btn btn-secondary" onclick="testDeleteFunction()">ğŸ§ª Testar Delete</button>
            <button class="btn btn-secondary" onclick="clearLog()">ğŸ“‹ Limpar Log</button>
            <a href="agendamentos.html" class="btn btn-secondary">ğŸ“… Ir para Agendamentos</a>
        </div>

        <div class="test-section">
            <h3>ğŸ“… Agendamentos de Teste</h3>
            <div id="schedulesDisplay">
                <!-- Agendamentos serÃ£o exibidos aqui -->
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ Log de OperaÃ§Ãµes</h3>
            <div id="logOutput" class="log"></div>
        </div>

        <div class="test-section">
            <h3>âœ… Resultados dos Testes</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <script>
        let schedules = [];
        let logOutput = [];
        let testResults = [];

        // FunÃ§Ã£o para adicionar log
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logOutput.push(logEntry);
            
            const logElement = document.getElementById('logOutput');
            if (logElement) {
                logElement.textContent = logOutput.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // FunÃ§Ã£o para adicionar resultado de teste
        function addTestResult(testName, success, details = '') {
            const result = {
                name: testName,
                success: success,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            };
            testResults.push(result);
            updateTestResultsDisplay();
        }

        // Atualizar exibiÃ§Ã£o dos resultados
        function updateTestResultsDisplay() {
            const resultsDiv = document.getElementById('testResults');
            if (!resultsDiv) return;

            const resultsHTML = testResults.map(result => `
                <div class="test-result">
                    <div class="status ${result.success ? 'success' : 'error'}">
                        ${result.success ? 'âœ…' : 'âŒ'} ${result.name}
                    </div>
                    <div style="font-size: 0.8rem; color: #8b949e; margin-top: 0.5rem;">
                        ${result.details} (${result.timestamp})
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = resultsHTML;
        }

        // Verificar status do sistema
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            const sessionManager = window.sessionManager;
            const currentUser = sessionManager ? sessionManager.getCurrentUser() : null;
            
            let statusHTML = '';
            statusHTML += `<div class="status ${sessionManager ? 'success' : 'error'}">`;
            statusHTML += `${sessionManager ? 'âœ…' : 'âŒ'} SessionManager: ${sessionManager ? 'DisponÃ­vel' : 'NÃ£o encontrado'}`;
            statusHTML += '</div>';
            
            if (currentUser) {
                statusHTML += `<div class="status success">`;
                statusHTML += `ğŸ‘¤ UsuÃ¡rio: ${currentUser.name} (ID: ${currentUser.id})`;
                statusHTML += '</div>';
            } else {
                statusHTML += `<div class="status info">`;
                statusHTML += `ğŸ‘¤ UsuÃ¡rio: Nenhum usuÃ¡rio logado`;
                statusHTML += '</div>';
            }
            
            statusDiv.innerHTML = statusHTML;
        }

        // Criar dados de teste
        function createTestData() {
            addLog('ğŸ“ Criando dados de teste...');
            
            const testSchedules = [
                {
                    id: 'test_delete_1_' + Date.now(),
                    title: 'MeditaÃ§Ã£o Teste 1',
                    time: '08:00',
                    category: 'Salmos',
                    days: ['seg', 'qua', 'sex'],
                    notifications: true,
                    date: new Date().toISOString().split('T')[0],
                    duration: 15,
                    status: 'agendado',
                    createdAt: new Date().toISOString(),
                    description: 'Agendamento de teste 1',
                    userId: 'test_user',
                    userName: 'UsuÃ¡rio Teste'
                },
                {
                    id: 'test_delete_2_' + Date.now(),
                    title: 'MeditaÃ§Ã£o Teste 2',
                    time: '12:00',
                    category: 'JaculatÃ³rias',
                    days: ['ter', 'qui'],
                    notifications: false,
                    date: new Date().toISOString().split('T')[0],
                    duration: 10,
                    status: 'agendado',
                    createdAt: new Date().toISOString(),
                    description: 'Agendamento de teste 2',
                    userId: 'test_user',
                    userName: 'UsuÃ¡rio Teste'
                },
                {
                    id: 'test_delete_3_' + Date.now(),
                    title: 'MeditaÃ§Ã£o Teste 3',
                    time: '18:00',
                    category: 'Evangelho',
                    days: ['dom'],
                    notifications: true,
                    date: new Date().toISOString().split('T')[0],
                    duration: 20,
                    status: 'agendado',
                    createdAt: new Date().toISOString(),
                    description: 'Agendamento de teste 3',
                    userId: 'test_user',
                    userName: 'UsuÃ¡rio Teste'
                }
            ];

            localStorage.setItem('user_schedules', JSON.stringify(testSchedules));
            addLog(`âœ… ${testSchedules.length} agendamentos de teste criados`);
            addTestResult('CriaÃ§Ã£o de Dados', true, `${testSchedules.length} agendamentos criados`);
            
            loadAndDisplay();
        }

        // Limpar dados de teste
        function clearTestData() {
            localStorage.removeItem('user_schedules');
            schedules = [];
            addLog('ğŸ—‘ï¸ Dados de teste removidos');
            addTestResult('Limpeza de Dados', true, 'Dados removidos com sucesso');
            loadAndDisplay();
        }

        // Carregar e exibir dados
        function loadAndDisplay() {
            try {
                const allSchedules = JSON.parse(localStorage.getItem('user_schedules') || '[]');
                const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : null;
                const userId = currentUser ? currentUser.id : 'test_user';
                
                schedules = allSchedules.filter(schedule => schedule.userId === userId);
                
                addLog(`ğŸ“… Carregados ${schedules.length} agendamentos para usuÃ¡rio ${userId}`);
                displaySchedules();
                addTestResult('Carregamento de Dados', true, `${schedules.length} agendamentos carregados`);
                
            } catch (error) {
                addLog(`âŒ Erro ao carregar dados: ${error.message}`, 'error');
                addTestResult('Carregamento de Dados', false, error.message);
            }
        }

        // Exibir agendamentos
        function displaySchedules() {
            const displayDiv = document.getElementById('schedulesDisplay');
            
            if (schedules.length === 0) {
                displayDiv.innerHTML = `
                    <div class="status info">
                        ğŸ“… Nenhum agendamento encontrado
                    </div>
                `;
                return;
            }

            const schedulesHTML = schedules.map(schedule => `
                <div class="schedule-item" data-schedule-id="${schedule.id}">
                    <div class="schedule-info">
                        <span>ğŸ• ${schedule.time}</span>
                        <span>ğŸ“– ${schedule.category}</span>
                        <span>ğŸ“… ${schedule.days.join(', ')}</span>
                        <span>ğŸ‘¤ ${schedule.userName}</span>
                    </div>
                    <div class="schedule-actions">
                        <button class="action-btn" onclick="editSchedule('${schedule.id}')">âœï¸</button>
                        <button class="action-btn delete" onclick="deleteSchedule('${schedule.id}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');

            displayDiv.innerHTML = schedulesHTML;
            addLog(`âœ… ${schedules.length} agendamentos exibidos`);
        }

        // FunÃ§Ã£o de delete testada
        function deleteSchedule(scheduleId) {
            addLog(`ğŸ—‘ï¸ === INÃCIO DA EXCLUSÃƒO ===`);
            addLog(`ğŸ—‘ï¸ ID recebido: ${scheduleId} (Tipo: ${typeof scheduleId})`);
            addLog(`ğŸ“‹ Total de agendamentos antes: ${schedules.length}`);
            
            if (!scheduleId) {
                addLog(`âŒ ID do agendamento Ã© invÃ¡lido: ${scheduleId}`, 'error');
                addTestResult('ValidaÃ§Ã£o de ID', false, 'ID invÃ¡lido');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                try {
                    const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : null;
                    const userId = currentUser ? currentUser.id : 'test_user';
                    
                    addLog(`ğŸ‘¤ UsuÃ¡rio atual: ${currentUser ? currentUser.name : 'N/A'} (ID: ${userId})`);
                    
                    const scheduleIdStr = String(scheduleId);
                    addLog(`ğŸ”„ ID convertido para string: ${scheduleIdStr}`);
                    
                    const scheduleExists = schedules.some(s => String(s.id) === scheduleIdStr);
                    addLog(`ğŸ” Agendamento existe? ${scheduleExists}`);
                    
                    if (!scheduleExists) {
                        addLog(`âŒ Agendamento nÃ£o encontrado no array local`, 'error');
                        addTestResult('VerificaÃ§Ã£o de ExistÃªncia', false, 'Agendamento nÃ£o encontrado');
                        return;
                    }
                    
                    const originalLength = schedules.length;
                    const filteredSchedules = schedules.filter(s => String(s.id) !== scheduleIdStr);
                    schedules = filteredSchedules;
                    
                    const removed = originalLength - schedules.length;
                    addLog(`ğŸ” Resultado da filtragem: ${originalLength} â†’ ${schedules.length} (removidos: ${removed})`);
                    
                    if (removed !== 1) {
                        addLog(`âŒ Erro na filtragem: nÃºmero incorreto de itens removidos`, 'error');
                        addTestResult('Filtragem', false, `Removidos ${removed} itens (esperado: 1)`);
                        return;
                    }
                    
                    const allSchedules = JSON.parse(localStorage.getItem('user_schedules') || '[]');
                    addLog(`ğŸ’¾ Total de agendamentos no localStorage: ${allSchedules.length}`);
                    
                    const otherUsersSchedules = allSchedules.filter(schedule => schedule.userId !== userId);
                    const updatedAllSchedules = [...otherUsersSchedules, ...schedules];
                    
                    localStorage.setItem('user_schedules', JSON.stringify(updatedAllSchedules));
                    addLog(`âœ… localStorage atualizado. Total final: ${updatedAllSchedules.length}`);
                    
                    displaySchedules();
                    
                    addLog(`âœ… === EXCLUSÃƒO CONCLUÃDA COM SUCESSO ===`);
                    addTestResult('ExclusÃ£o Completa', true, `Agendamento ${scheduleId} removido com sucesso`);
                    
                } catch (error) {
                    addLog(`âŒ Erro durante a exclusÃ£o: ${error.message}`, 'error');
                    addTestResult('ExclusÃ£o', false, error.message);
                }
            } else {
                addLog(`âŒ ExclusÃ£o cancelada pelo usuÃ¡rio`);
                addTestResult('ConfirmaÃ§Ã£o do UsuÃ¡rio', false, 'UsuÃ¡rio cancelou a exclusÃ£o');
            }
        }

        // FunÃ§Ã£o de ediÃ§Ã£o (simulada)
        function editSchedule(scheduleId) {
            addLog(`âœï¸ FunÃ§Ã£o de ediÃ§Ã£o chamada para: ${scheduleId}`);
            alert(`FunÃ§Ã£o de ediÃ§Ã£o para agendamento: ${scheduleId}`);
        }

        // Testar funÃ§Ã£o de delete
        function testDeleteFunction() {
            addLog('ğŸ§ª Testando funÃ§Ã£o de delete...');
            
            if (schedules.length === 0) {
                addLog('âš ï¸ Nenhum agendamento para testar', 'error');
                addTestResult('Teste de Delete', false, 'Nenhum agendamento disponÃ­vel');
                return;
            }
            
            const testSchedule = schedules[0];
            addLog(`ğŸ§ª Testando exclusÃ£o do agendamento: ${testSchedule.title} (ID: ${testSchedule.id})`);
            
            // Simular exclusÃ£o sem confirmaÃ§Ã£o
            const currentUser = window.sessionManager ? window.sessionManager.getCurrentUser() : null;
            const userId = currentUser ? currentUser.id : 'test_user';
            
            const allSchedules = JSON.parse(localStorage.getItem('user_schedules') || '[]');
            const otherUsersSchedules = allSchedules.filter(schedule => schedule.userId !== userId);
            
            const updatedSchedules = schedules.filter(s => s.id !== testSchedule.id);
            const updatedAllSchedules = [...otherUsersSchedules, ...updatedSchedules];
            
            localStorage.setItem('user_schedules', JSON.stringify(updatedAllSchedules));
            schedules = updatedSchedules;
            
            addLog(`âœ… Teste de exclusÃ£o concluÃ­do. Agendamentos restantes: ${schedules.length}`);
            displaySchedules();
            addTestResult('Teste AutomÃ¡tico', true, `Agendamento ${testSchedule.id} removido automaticamente`);
        }

        // Limpar log
        function clearLog() {
            logOutput = [];
            testResults = [];
            document.getElementById('logOutput').textContent = '';
            updateTestResultsDisplay();
            addLog('ğŸ“‹ Log limpo');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸš€ PÃ¡gina de teste carregada');
            checkSystemStatus();
            loadAndDisplay();
        });
    </script>
</body>
</html> 