<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Sincroniza√ß√£o de Exclus√£o</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }
        .test-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #5a6fd8;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .meditation-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Sincroniza√ß√£o de Exclus√£o</h1>
        
        <div class="test-section">
            <h3>üìã Verificar Supabase Manager</h3>
            <button onclick="checkSupabaseManager()">Verificar Supabase Manager</button>
            <div id="supabase-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìù Carregar Medita√ß√µes Personalizadas</h3>
            <button onclick="loadPersonalizedMeditations()">Carregar do LocalStorage</button>
            <button onclick="loadSupabaseMeditations()">Carregar do Supabase</button>
            <div id="meditations-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üóëÔ∏è Testar Exclus√£o</h3>
            <button onclick="testDeleteFunction()">Testar Fun√ß√£o de Exclus√£o</button>
            <button onclick="deleteRandomMeditation()" class="danger">Excluir Medita√ß√£o Aleat√≥ria</button>
            <div id="delete-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ Verificar Sincroniza√ß√£o</h3>
            <button onclick="checkSync()">Verificar Sincroniza√ß√£o</button>
            <div id="sync-result" class="result"></div>
        </div>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        let currentMeditations = [];

        // Verificar Supabase Manager
        function checkSupabaseManager() {
            const result = document.getElementById('supabase-result');
            result.innerHTML = '';
            
            try {
                if (window.supabaseManager) {
                    result.innerHTML += '‚úÖ Supabase Manager dispon√≠vel\n';
                    result.innerHTML += `üìù Tipo: ${typeof window.supabaseManager}\n`;
                    result.innerHTML += `üîó URL: ${window.supabaseManager.supabaseUrl}\n`;
                } else {
                    result.innerHTML += '‚ùå Supabase Manager n√£o dispon√≠vel\n';
                }
            } catch (error) {
                result.innerHTML += `‚ùå Erro: ${error.message}\n`;
            }
        }

        // Carregar medita√ß√µes do LocalStorage
        function loadPersonalizedMeditations() {
            const result = document.getElementById('meditations-result');
            result.innerHTML = 'üîÑ Carregando medita√ß√µes do LocalStorage...\n';
            
            try {
                const personalizedData = localStorage.getItem('personalized_meditations');
                if (personalizedData) {
                    currentMeditations = JSON.parse(personalizedData);
                    result.innerHTML = `‚úÖ Medita√ß√µes carregadas do LocalStorage: ${currentMeditations.length}\n\n`;
                    
                    currentMeditations.forEach((meditation, index) => {
                        result.innerHTML += `${index + 1}. ${meditation.title}\n`;
                        result.innerHTML += `   ID: ${meditation.id}\n`;
                        result.innerHTML += `   T√≥pico: ${meditation.topic}\n`;
                        result.innerHTML += `   Status: ${meditation.status}\n\n`;
                    });
                } else {
                    result.innerHTML = '‚ùå Nenhuma medita√ß√£o encontrada no LocalStorage\n';
                }
            } catch (error) {
                result.innerHTML = `‚ùå Erro: ${error.message}\n`;
            }
        }

        // Carregar medita√ß√µes do Supabase
        async function loadSupabaseMeditations() {
            const result = document.getElementById('meditations-result');
            result.innerHTML = 'üîÑ Carregando medita√ß√µes do Supabase...\n';
            
            try {
                if (!window.supabaseManager) {
                    throw new Error('Supabase Manager n√£o dispon√≠vel');
                }
                
                const supabaseMeditations = await window.supabaseManager.getPersonalizedMeditations();
                result.innerHTML = `‚úÖ Medita√ß√µes carregadas do Supabase: ${supabaseMeditations.length}\n\n`;
                
                supabaseMeditations.forEach((meditation, index) => {
                    result.innerHTML += `${index + 1}. ${meditation.title}\n`;
                    result.innerHTML += `   ID: ${meditation.id}\n`;
                    result.innerHTML += `   Meditation ID: ${meditation.meditation_id}\n`;
                    result.innerHTML += `   T√≥pico: ${meditation.topic}\n`;
                    result.innerHTML += `   Status: ${meditation.status}\n\n`;
                });
            } catch (error) {
                result.innerHTML = `‚ùå Erro: ${error.message}\n`;
            }
        }

        // Testar fun√ß√£o de exclus√£o
        function testDeleteFunction() {
            const result = document.getElementById('delete-result');
            result.innerHTML = 'üß™ Testando fun√ß√£o de exclus√£o...\n';
            
            try {
                // Simular uma medita√ß√£o para teste
                const testMeditation = {
                    id: 'test-meditation-id',
                    title: 'Medita√ß√£o de Teste',
                    topic: 'Teste',
                    status: 'pending'
                };
                
                result.innerHTML += 'üìù Medita√ß√£o de teste criada\n';
                result.innerHTML += `   ID: ${testMeditation.id}\n`;
                result.innerHTML += `   T√≠tulo: ${testMeditation.title}\n`;
                
                // Verificar se a fun√ß√£o existe
                if (typeof deleteMeditation === 'function') {
                    result.innerHTML += '‚úÖ Fun√ß√£o deleteMeditation encontrada\n';
                } else {
                    result.innerHTML += '‚ùå Fun√ß√£o deleteMeditation n√£o encontrada\n';
                }
                
                // Verificar se √© async
                if (deleteMeditation.constructor.name === 'AsyncFunction') {
                    result.innerHTML += '‚úÖ Fun√ß√£o √© ass√≠ncrona\n';
                } else {
                    result.innerHTML += '‚ö†Ô∏è Fun√ß√£o n√£o √© ass√≠ncrona\n';
                }
                
            } catch (error) {
                result.innerHTML += `‚ùå Erro: ${error.message}\n`;
            }
        }

        // Excluir medita√ß√£o aleat√≥ria
        async function deleteRandomMeditation() {
            const result = document.getElementById('delete-result');
            result.innerHTML = 'üóëÔ∏è Excluindo medita√ß√£o aleat√≥ria...\n';
            
            try {
                if (currentMeditations.length === 0) {
                    result.innerHTML += '‚ùå Nenhuma medita√ß√£o dispon√≠vel para exclus√£o\n';
                    return;
                }
                
                // Escolher medita√ß√£o aleat√≥ria
                const randomIndex = Math.floor(Math.random() * currentMeditations.length);
                const meditationToDelete = currentMeditations[randomIndex];
                
                result.innerHTML += `üìù Medita√ß√£o selecionada: ${meditationToDelete.title}\n`;
                result.innerHTML += `   ID: ${meditationToDelete.id}\n`;
                
                // Chamar fun√ß√£o de exclus√£o
                await deleteMeditation(meditationToDelete.id);
                
                result.innerHTML += '‚úÖ Fun√ß√£o de exclus√£o executada\n';
                
            } catch (error) {
                result.innerHTML += `‚ùå Erro: ${error.message}\n`;
            }
        }

        // Verificar sincroniza√ß√£o
        async function checkSync() {
            const result = document.getElementById('sync-result');
            result.innerHTML = 'üîÑ Verificando sincroniza√ß√£o...\n';
            
            try {
                // Carregar do LocalStorage
                const localStorageData = localStorage.getItem('personalized_meditations');
                const localMeditations = localStorageData ? JSON.parse(localStorageData) : [];
                
                result.innerHTML += `üì± LocalStorage: ${localMeditations.length} medita√ß√µes\n`;
                
                // Carregar do Supabase
                if (window.supabaseManager) {
                    const supabaseMeditations = await window.supabaseManager.getPersonalizedMeditations();
                    result.innerHTML += `‚òÅÔ∏è Supabase: ${supabaseMeditations.length} medita√ß√µes\n`;
                    
                    // Comparar IDs
                    const localIds = localMeditations.map(m => m.id).sort();
                    const supabaseIds = supabaseMeditations.map(m => m.meditation_id).sort();
                    
                    const localIdsStr = localIds.join(', ');
                    const supabaseIdsStr = supabaseIds.join(', ');
                    
                    result.innerHTML += `\nüì± IDs LocalStorage: ${localIdsStr}\n`;
                    result.innerHTML += `‚òÅÔ∏è IDs Supabase: ${supabaseIdsStr}\n`;
                    
                    if (localIds.length === supabaseIds.length && localIds.every((id, index) => id === supabaseIds[index])) {
                        result.innerHTML += '\n‚úÖ Sincroniza√ß√£o OK - IDs coincidem\n';
                    } else {
                        result.innerHTML += '\n‚ö†Ô∏è Sincroniza√ß√£o inconsistente - IDs n√£o coincidem\n';
                    }
                } else {
                    result.innerHTML += '‚ùå Supabase Manager n√£o dispon√≠vel\n';
                }
                
            } catch (error) {
                result.innerHTML += `‚ùå Erro: ${error.message}\n`;
            }
        }

        // Fun√ß√£o de exclus√£o simulada (baseada na fun√ß√£o real)
        async function deleteMeditation(meditationId) {
            console.log('üóëÔ∏è Iniciando exclus√£o da medita√ß√£o:', meditationId);
            
            try {
                // Obter usu√°rio atual
                const currentUser = JSON.parse(localStorage.getItem('userData') || '{}');
                const userId = currentUser.id || 'anonymous';
                
                const personalizedData = localStorage.getItem('personalized_meditations');
                if (personalizedData) {
                    const allMeditations = JSON.parse(personalizedData);
                    
                    // Verificar se a medita√ß√£o existe antes de deletar
                    const meditationToDelete = allMeditations.find(med => 
                        med.id === meditationId && med.userId === userId
                    );
                    
                    if (meditationToDelete) {
                        console.log('üìù Medita√ß√£o encontrada para exclus√£o:', meditationToDelete.title);
                        
                        // Sincronizar com Supabase se dispon√≠vel
                        console.log('üîÑ Verificando Supabase Manager...');
                        if (window.supabaseManager) {
                            try {
                                console.log('üì§ Excluindo medita√ß√£o personalizada do Supabase...');
                                
                                // Buscar a medita√ß√£o no Supabase pelo meditation_id
                                const supabaseMeditations = await window.supabaseManager.getPersonalizedMeditations();
                                const supabaseMeditation = supabaseMeditations.find(med => 
                                    med.meditation_id === meditationId
                                );
                                
                                if (supabaseMeditation) {
                                    console.log('üóëÔ∏è Excluindo do Supabase:', supabaseMeditation.id);
                                    await window.supabaseManager.deletePersonalizedMeditation(supabaseMeditation.id);
                                    console.log('‚úÖ Medita√ß√£o exclu√≠da do Supabase com sucesso');
                                } else {
                                    console.log('‚ö†Ô∏è Medita√ß√£o n√£o encontrada no Supabase');
                                }
                            } catch (supabaseError) {
                                console.error('‚ö†Ô∏è Erro ao excluir do Supabase:', supabaseError);
                                console.log('‚ÑπÔ∏è Medita√ß√£o exclu√≠da apenas localmente');
                            }
                        } else {
                            console.log('‚ÑπÔ∏è Supabase Manager n√£o dispon√≠vel - exclus√£o apenas local');
                        }
                        
                        // Remover apenas a medita√ß√£o do usu√°rio atual
                        const updatedMeditations = allMeditations.filter(med => 
                            !(med.id === meditationId && med.userId === userId)
                        );
                        localStorage.setItem('personalized_meditations', JSON.stringify(updatedMeditations));
                        
                        console.log('‚úÖ Medita√ß√£o exclu√≠da com sucesso!');
                    } else {
                        console.log('‚ùå Medita√ß√£o n√£o encontrada.');
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao excluir medita√ß√£o:', error);
            }
        }

        // Verificar Supabase Manager ao carregar
        window.addEventListener('load', function() {
            setTimeout(checkSupabaseManager, 1000);
        });
    </script>
</body>
</html> 