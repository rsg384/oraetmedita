<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Completo - Ora et Medita</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #2a2a3e; padding: 20px; margin: 20px 0; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #8B5CF6; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .log { background: #0F0F23; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .warning { color: #F59E0B; }
        .info { color: #3B82F6; }
        input { padding: 10px; width: 300px; margin: 10px; border-radius: 4px; border: 1px solid #374151; background: #1A1A2E; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Completo - Ora et Medita</h1>
        
        <div class="section">
            <h2>1. Teste de Configura√ß√£o</h2>
            <button onclick="testConfig()">Verificar Configura√ß√£o da API</button>
            <button onclick="testLocalStorage()">Verificar LocalStorage</button>
            <button onclick="clearAllData()">Limpar Todos os Dados</button>
            <div id="config-log" class="log"></div>
        </div>

        <div class="section">
            <h2>2. Teste de Gera√ß√£o</h2>
            <input type="text" id="test-topic" placeholder="Digite um tema (ex: Amor de Deus)" value="Amor de Deus">
            <button onclick="testGeneration()">Testar Gera√ß√£o de Medita√ß√µes</button>
            <button onclick="testGenerationWithDelay()">Testar com Delay (3s)</button>
            <div id="generation-log" class="log"></div>
        </div>

        <div class="section">
            <h2>3. Teste de Redirecionamento</h2>
            <button onclick="testRedirect()">Testar Redirecionamento</button>
            <button onclick="testRedirectWithData()">Testar Redirecionamento com Dados</button>
            <div id="redirect-log" class="log"></div>
        </div>

        <div class="section">
            <h2>4. Teste de Carregamento</h2>
            <button onclick="testLoadMeditations()">Testar Carregamento de Medita√ß√µes</button>
            <button onclick="simulateFullFlow()">Simular Fluxo Completo</button>
            <div id="load-log" class="log"></div>
        </div>

        <div class="section">
            <h2>5. Dados Atuais</h2>
            <button onclick="showCurrentData()">Mostrar Dados Atuais</button>
            <div id="data-log" class="log"></div>
        </div>
    </div>

    <script src="api-config.js"></script>
    <script src="chatgpt-api.js"></script>
    <script>
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 1. Teste de Configura√ß√£o
        async function testConfig() {
            const logId = 'config-log';
            log(logId, 'üîß Iniciando teste de configura√ß√£o...', 'info');
            
            try {
                // Verificar se a API est√° carregada
                if (typeof chatGPTAPI === 'undefined') {
                    throw new Error('chatGPTAPI n√£o est√° definida');
                }
                log(logId, '‚úÖ chatGPTAPI carregada com sucesso', 'success');
                
                // Verificar configura√ß√£o
                if (!chatGPTAPI.config.API_KEY) {
                    throw new Error('API_KEY n√£o configurada');
                }
                log(logId, '‚úÖ API_KEY configurada', 'success');
                
                // Verificar se os documentos est√£o carregados
                const documents = await chatGPTAPI.loadDocuments();
                log(logId, `‚úÖ ${documents.length} documentos carregados`, 'success');
                
                log(logId, '‚úÖ Configura√ß√£o OK!', 'success');
                
            } catch (error) {
                log(logId, `‚ùå Erro na configura√ß√£o: ${error.message}`, 'error');
            }
        }

        function testLocalStorage() {
            const logId = 'config-log';
            log(logId, 'üîß Verificando localStorage...', 'info');
            
            try {
                const keys = ['personalized_meditations', 'personalized_meditations_history', 'current_topic', 'generation_date'];
                
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    if (value) {
                        log(logId, `‚úÖ ${key}: ${value.length} caracteres`, 'success');
                    } else {
                        log(logId, `‚ö†Ô∏è ${key}: n√£o encontrado`, 'warning');
                    }
                });
                
            } catch (error) {
                log(logId, `‚ùå Erro no localStorage: ${error.message}`, 'error');
            }
        }

        function clearAllData() {
            const logId = 'config-log';
            log(logId, 'üßπ Limpando todos os dados...', 'info');
            
            try {
                localStorage.removeItem('personalized_meditations');
                localStorage.removeItem('personalized_meditations_history');
                localStorage.removeItem('current_topic');
                localStorage.removeItem('generation_date');
                localStorage.removeItem('pending_topic');
                
                log(logId, '‚úÖ Todos os dados removidos', 'success');
                
            } catch (error) {
                log(logId, `‚ùå Erro ao limpar dados: ${error.message}`, 'error');
            }
        }

        // 2. Teste de Gera√ß√£o
        async function testGeneration() {
            const logId = 'generation-log';
            const topic = document.getElementById('test-topic').value || 'Amor de Deus';
            
            log(logId, `üöÄ Iniciando gera√ß√£o para: "${topic}"`, 'info');
            
            try {
                const startTime = Date.now();
                const result = await chatGPTAPI.generateMeditations(topic);
                const endTime = Date.now();
                
                log(logId, `‚úÖ Gera√ß√£o conclu√≠da em ${endTime - startTime}ms`, 'success');
                log(logId, `üìä Resultado: ${result.meditations.length} medita√ß√µes`, 'success');
                log(logId, `üìù Categoria: ${result.category}`, 'success');
                
                // Verificar estrutura
                result.meditations.forEach((med, index) => {
                    log(logId, `üìñ Medita√ß√£o ${index + 1}: ${med.title}`, 'info');
                });
                
                // Salvar no localStorage
                localStorage.setItem('personalized_meditations', JSON.stringify(result));
                log(logId, 'üíæ Dados salvos no localStorage', 'success');
                
            } catch (error) {
                log(logId, `‚ùå Erro na gera√ß√£o: ${error.message}`, 'error');
                log(logId, `üìã Stack: ${error.stack}`, 'error');
            }
        }

        async function testGenerationWithDelay() {
            const logId = 'generation-log';
            log(logId, '‚è≥ Aguardando 3 segundos antes da gera√ß√£o...', 'info');
            
            setTimeout(async () => {
                await testGeneration();
            }, 3000);
        }

        // 3. Teste de Redirecionamento
        function testRedirect() {
            const logId = 'redirect-log';
            log(logId, 'üîÑ Testando redirecionamento...', 'info');
            
            try {
                log(logId, `üìç URL atual: ${window.location.href}`, 'info');
                log(logId, `üîó URL de destino: ${window.location.origin}/minhas-meditacoes.html`, 'info');
                
                // Testar se a p√°gina existe
                fetch('minhas-meditacoes.html')
                    .then(response => {
                        log(logId, `‚úÖ P√°gina encontrada: ${response.status}`, 'success');
                        log(logId, 'üöÄ Redirecionando...', 'info');
                        window.location.href = 'minhas-meditacoes.html';
                    })
                    .catch(error => {
                        log(logId, `‚ùå Erro ao acessar p√°gina: ${error.message}`, 'error');
                    });
                
            } catch (error) {
                log(logId, `‚ùå Erro no redirecionamento: ${error.message}`, 'error');
            }
        }

        function testRedirectWithData() {
            const logId = 'redirect-log';
            log(logId, 'üîÑ Testando redirecionamento com dados...', 'info');
            
            // Criar dados de teste
            const testData = {
                category: 'Teste Debug',
                total: 7,
                meditations: [
                    {
                        id: 1,
                        title: 'Medita√ß√£o de Teste 1',
                        duration: '20 min',
                        status: 'completed',
                        reading: 'Texto de leitura de teste',
                        meditation: 'Texto de medita√ß√£o de teste',
                        prayer: 'Texto de ora√ß√£o de teste',
                        contemplation: 'Texto de contempla√ß√£o de teste',
                        references: 'Refer√™ncias de teste',
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    }
                ],
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('personalized_meditations', JSON.stringify(testData));
            log(logId, 'üíæ Dados de teste salvos', 'success');
            
            setTimeout(() => {
                log(logId, 'üöÄ Redirecionando com dados...', 'info');
                window.location.href = 'minhas-meditacoes.html';
            }, 1000);
        }

        // 4. Teste de Carregamento
        function testLoadMeditations() {
            const logId = 'load-log';
            log(logId, 'üìñ Testando carregamento de medita√ß√µes...', 'info');
            
            try {
                const data = localStorage.getItem('personalized_meditations');
                if (!data) {
                    log(logId, '‚ö†Ô∏è Nenhum dado encontrado no localStorage', 'warning');
                    return;
                }
                
                const parsed = JSON.parse(data);
                log(logId, `‚úÖ Dados carregados: ${parsed.meditations.length} medita√ß√µes`, 'success');
                log(logId, `üìù Categoria: ${parsed.category}`, 'success');
                
                parsed.meditations.forEach((med, index) => {
                    log(logId, `üìñ ${index + 1}. ${med.title}`, 'info');
                });
                
            } catch (error) {
                log(logId, `‚ùå Erro ao carregar: ${error.message}`, 'error');
            }
        }

        async function simulateFullFlow() {
            const logId = 'load-log';
            log(logId, 'üé≠ Simulando fluxo completo...', 'info');
            
            try {
                // 1. Gerar medita√ß√µes
                log(logId, '1Ô∏è‚É£ Gerando medita√ß√µes...', 'info');
                const result = await chatGPTAPI.generateMeditations('Amor de Deus');
                
                // 2. Salvar no localStorage
                log(logId, '2Ô∏è‚É£ Salvando no localStorage...', 'info');
                localStorage.setItem('personalized_meditations', JSON.stringify(result));
                
                // 3. Aguardar um pouco
                log(logId, '3Ô∏è‚É£ Aguardando 2 segundos...', 'info');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 4. Redirecionar
                log(logId, '4Ô∏è‚É£ Redirecionando...', 'info');
                window.location.href = 'minhas-meditacoes.html';
                
            } catch (error) {
                log(logId, `‚ùå Erro no fluxo: ${error.message}`, 'error');
            }
        }

        // 5. Mostrar Dados Atuais
        function showCurrentData() {
            const logId = 'data-log';
            log(logId, 'üìä Dados atuais no localStorage:', 'info');
            
            const keys = ['personalized_meditations', 'personalized_meditations_history', 'current_topic', 'generation_date', 'pending_topic'];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        log(logId, `‚úÖ ${key}: ${JSON.stringify(parsed, null, 2)}`, 'success');
                    } catch {
                        log(logId, `üìù ${key}: ${value}`, 'info');
                    }
                } else {
                    log(logId, `‚ö†Ô∏è ${key}: n√£o encontrado`, 'warning');
                }
            });
        }

        // Auto-executar teste de configura√ß√£o
        window.addEventListener('load', () => {
            log('config-log', 'üöÄ P√°gina de debug carregada', 'success');
            testConfig();
        });
    </script>
</body>
</html> 