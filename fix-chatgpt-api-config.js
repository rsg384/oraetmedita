// Script para corrigir busca da chave da API do ChatGPT no Supabase
console.log('üîß Corrigindo busca da chave da API do ChatGPT...');

// Fun√ß√£o para buscar chave da API no Supabase
async function getApiKeyFromSupabase() {
    console.log('üîç Buscando chave da API no Supabase...');
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/api_configs?select=*`, {
            method: 'GET',
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìã Configura√ß√µes de API encontradas:', data);
        
        if (data && data.length > 0) {
            const apiConfig = data[0]; // Pega a primeira configura√ß√£o
            const apiKey = apiConfig.openai_api_key || apiConfig.api_key;
            
            if (apiKey) {
                console.log('‚úÖ Chave da API encontrada no Supabase');
                return apiKey;
            } else {
                console.warn('‚ö†Ô∏è Chave da API n√£o encontrada na configura√ß√£o');
                return null;
            }
        } else {
            console.warn('‚ö†Ô∏è Nenhuma configura√ß√£o de API encontrada no Supabase');
            return null;
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar chave da API no Supabase:', error);
        return null;
    }
}

// Fun√ß√£o para sobrescrever a fun√ß√£o de gera√ß√£o de medita√ß√µes
function fixChatGptApiGeneration() {
    console.log('üîß Corrigindo gera√ß√£o de medita√ß√µes via ChatGPT...');
    
    // Sobrescrever a fun√ß√£o de gera√ß√£o de medita√ß√µes
    if (window.generateMeditationWithChatGPT) {
        const originalFunction = window.generateMeditationWithChatGPT;
        
        window.generateMeditationWithChatGPT = async function(category, title, description) {
            console.log('üîÑ Gerando medita√ß√£o com ChatGPT (vers√£o corrigida)...');
            
            try {
                // Buscar chave da API no Supabase
                const apiKey = await getApiKeyFromSupabase();
                
                if (!apiKey) {
                    throw new Error('Chave da API do ChatGPT n√£o encontrada no Supabase');
                }
                
                console.log('‚úÖ Usando chave da API do Supabase');
                
                // Configurar headers com a chave do Supabase
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };
                
                // Preparar prompt para o ChatGPT
                const prompt = `
                Crie uma medita√ß√£o cat√≥lica baseada na categoria "${category}" com o t√≠tulo "${title}".
                
                Descri√ß√£o da categoria: ${description}
                
                A medita√ß√£o deve incluir:
                1. Uma introdu√ß√£o espiritual
                2. Um texto b√≠blico relevante
                3. Reflex√µes profundas sobre o tema
                4. Uma ora√ß√£o final
                5. Uma aplica√ß√£o pr√°tica para a vida di√°ria
                
                Formato da resposta:
                {
                    "title": "T√≠tulo da Medita√ß√£o",
                    "content": "Conte√∫do completo da medita√ß√£o",
                    "bible_verse": "Vers√≠culo b√≠blico",
                    "prayer": "Ora√ß√£o final",
                    "practical_application": "Aplica√ß√£o pr√°tica"
                }
                `;
                
                // Fazer requisi√ß√£o para a API do ChatGPT
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'Voc√™ √© um assistente especializado em criar medita√ß√µes cat√≥licas profundas e inspiradoras.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro na API do ChatGPT: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0]?.message?.content;
                
                if (!content) {
                    throw new Error('Resposta vazia da API do ChatGPT');
                }
                
                // Tentar fazer parse do JSON da resposta
                try {
                    const meditationData = JSON.parse(content);
                    console.log('‚úÖ Medita√ß√£o gerada com sucesso via ChatGPT');
                    return meditationData;
                } catch (parseError) {
                    console.log('‚ö†Ô∏è Resposta n√£o √© JSON v√°lido, usando como texto simples');
                    return {
                        title: title,
                        content: content,
                        bible_verse: 'Vers√≠culo ser√° adicionado manualmente',
                        prayer: 'Ora√ß√£o ser√° adicionada manualmente',
                        practical_application: 'Aplica√ß√£o pr√°tica ser√° adicionada manualmente'
                    };
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar medita√ß√£o com ChatGPT:', error);
                throw error;
            }
        };
        
        console.log('‚úÖ Fun√ß√£o de gera√ß√£o de medita√ß√µes corrigida');
    } else {
        console.warn('‚ö†Ô∏è Fun√ß√£o generateMeditationWithChatGPT n√£o encontrada');
    }
}

// Fun√ß√£o para verificar se a tabela api_configs existe
async function checkApiConfigsTable() {
    console.log('üîç Verificando tabela api_configs...');
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/api_configs?select=count`, {
            method: 'GET',
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            console.log('‚úÖ Tabela api_configs existe');
            return true;
        } else {
            console.warn('‚ö†Ô∏è Tabela api_configs n√£o existe ou n√£o acess√≠vel');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao verificar tabela api_configs:', error);
        return false;
    }
}

// Fun√ß√£o para criar tabela api_configs se n√£o existir
async function createApiConfigsTable() {
    console.log('üîß Criando tabela api_configs...');
    
    try {
        // SQL para criar a tabela (ser√° executado via Supabase)
        const createTableSQL = `
        CREATE TABLE IF NOT EXISTS api_configs (
            id SERIAL PRIMARY KEY,
            openai_api_key TEXT,
            api_key TEXT,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        `;
        
        console.log('üìã SQL para criar tabela:', createTableSQL);
        console.log('‚ÑπÔ∏è Execute este SQL no painel do Supabase se a tabela n√£o existir');
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Erro ao criar tabela api_configs:', error);
        return false;
    }
}

// Fun√ß√£o para inserir chave da API de exemplo
async function insertSampleApiKey() {
    console.log('üîß Inserindo chave de API de exemplo...');
    
    try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/api_configs`, {
            method: 'POST',
            headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                openai_api_key: 'sua-chave-api-aqui',
                api_key: 'sua-chave-api-aqui'
            })
        });
        
        if (response.ok) {
            console.log('‚úÖ Chave de API de exemplo inserida');
            return true;
        } else {
            console.warn('‚ö†Ô∏è Erro ao inserir chave de API:', response.status);
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao inserir chave de API:', error);
        return false;
    }
}

// Fun√ß√£o principal para corrigir a API do ChatGPT
async function fixChatGptApi() {
    console.log('üîß Iniciando corre√ß√£o da API do ChatGPT...');
    
    // 1. Verificar se a tabela existe
    const tableExists = await checkApiConfigsTable();
    
    if (!tableExists) {
        console.log('üìã Tabela api_configs n√£o existe, criando...');
        await createApiConfigsTable();
        console.log('‚ÑπÔ∏è Execute o SQL no painel do Supabase para criar a tabela');
    }
    
    // 2. Tentar inserir chave de exemplo
    await insertSampleApiKey();
    
    // 3. Corrigir fun√ß√£o de gera√ß√£o
    fixChatGptApiGeneration();
    
    // 4. Testar busca da chave
    const apiKey = await getApiKeyFromSupabase();
    if (apiKey) {
        console.log('‚úÖ Configura√ß√£o da API do ChatGPT corrigida');
    } else {
        console.warn('‚ö†Ô∏è Configure a chave da API no Supabase');
    }
}

// Exportar fun√ß√µes
window.fixChatGptApi = fixChatGptApi;
window.getApiKeyFromSupabase = getApiKeyFromSupabase;
window.checkApiConfigsTable = checkApiConfigsTable;
window.createApiConfigsTable = createApiConfigsTable;
window.insertSampleApiKey = insertSampleApiKey;

// Auto-inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Script de corre√ß√£o da API do ChatGPT carregado');
    
    // Aguardar um pouco e executar corre√ß√£o
    setTimeout(async () => {
        console.log('üîß Executando corre√ß√£o autom√°tica da API do ChatGPT...');
        await fixChatGptApi();
    }, 1000);
});

console.log('‚úÖ Script de corre√ß√£o da API do ChatGPT carregado'); 