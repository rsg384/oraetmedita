// Sistema de Gerenciamento de Sess√µes para M√∫ltiplos Usu√°rios
class SessionManager {
    constructor() {
        this.currentSessionId = null;
        this.currentUser = null;
        this.init();
    }

    // Inicializar sess√£o
    init() {
        console.log('üöÄ Inicializando SessionManager...');
        
        // Gerar ID √∫nico para esta sess√£o
        this.currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('üÜî ID da sess√£o atual:', this.currentSessionId);
        
        // Salvar ID da sess√£o no localStorage
        localStorage.setItem('currentSessionId', this.currentSessionId);
        
        // Verificar se h√° usu√°rio logado nesta sess√£o
        this.loadCurrentUser();
        
        // Listener para mudan√ßas no localStorage (outras abas)
        window.addEventListener('storage', this.handleStorageChange.bind(this));
        
        console.log('‚úÖ SessionManager inicializado');
    }

    // Carregar usu√°rio atual da sess√£o
    loadCurrentUser() {
        try {
            const sessionData = localStorage.getItem(`session_${this.currentSessionId}`);
            if (sessionData) {
                this.currentUser = JSON.parse(sessionData);
                console.log('üë§ Usu√°rio carregado da sess√£o:', this.currentUser.name);
                return this.currentUser;
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar usu√°rio da sess√£o:', error);
        }
        return null;
    }

    // Fazer login de usu√°rio
    async loginUser(userData) {
        try {
            console.log('üîê Fazendo login do usu√°rio:', userData.email);
            
            // Carregar dados completos do admin
            const completeUserData = await this.loadUserDataFromAdmin(userData.email);
            
            // Adicionar informa√ß√µes da sess√£o
            const sessionUserData = {
                ...completeUserData,
                sessionId: this.currentSessionId,
                loginTime: new Date().toISOString(),
                lastActivity: new Date().toISOString()
            };
            
            // Salvar na sess√£o atual
            localStorage.setItem(`session_${this.currentSessionId}`, JSON.stringify(sessionUserData));
            
            // Atualizar usu√°rio atual
            this.currentUser = sessionUserData;
            
            // Adicionar sess√£o √† lista de sess√µes ativas
            this.addActiveSession(sessionUserData);
            
            console.log('‚úÖ Login realizado com sucesso:', sessionUserData.name);
            return sessionUserData;
            
        } catch (error) {
            console.error('‚ùå Erro no login:', error);
            throw error;
        }
    }

    // Fazer logout do usu√°rio
    logoutUser() {
        try {
            console.log('üö™ Fazendo logout do usu√°rio');
            
            if (this.currentUser) {
                // Remover sess√£o atual
                localStorage.removeItem(`session_${this.currentSessionId}`);
                
                // Remover da lista de sess√µes ativas
                this.removeActiveSession(this.currentSessionId);
                
                // Limpar usu√°rio atual
                this.currentUser = null;
                
                console.log('‚úÖ Logout realizado com sucesso');
            }
        } catch (error) {
            console.error('‚ùå Erro no logout:', error);
        }
    }

    // Obter usu√°rio atual
    getCurrentUser() {
        return this.currentUser;
    }

    // Verificar se h√° usu√°rio logado
    isLoggedIn() {
        return this.currentUser !== null;
    }

    // Carregar dados do usu√°rio do admin
    async loadUserDataFromAdmin(email) {
        try {
            console.log('üîç Carregando dados do usu√°rio do admin para:', email);
            
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            console.log('üìä Usu√°rios encontrados no admin:', users.length);
            
            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
            
            if (user) {
                console.log('‚úÖ Usu√°rio encontrado no admin:', user.name);
                
                // Carregar dados de progresso espiritual
                const spiritualProgress = this.loadSpiritualProgressData(user.id);
                
                return {
                    id: user.id,
                    name: user.name,
                    email: user.email,
                    userNumber: user.userNumber,
                    createdAt: user.createdAt,
                    lastLogin: new Date().toISOString(),
                    preferences: user.preferences || {},
                    stats: user.stats || {
                        consecutiveDays: 5,
                        completedMeditations: 12,
                        totalTime: '2h 30min',
                        totalMeditations: 15,
                        inProgressMeditations: 3
                    },
                    spiritualProgress: spiritualProgress
                };
            } else {
                console.log('‚ö†Ô∏è Usu√°rio n√£o encontrado no admin, criando novo...');
                
                const newUser = {
                    id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: email.split('@')[0],
                    email: email,
                    userNumber: users.length + 1,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    preferences: {},
                    stats: {
                        consecutiveDays: 0,
                        completedMeditations: 0,
                        totalTime: '0h 0min',
                        totalMeditations: 0,
                        inProgressMeditations: 0
                    },
                    spiritualProgress: this.loadSpiritualProgressData('new_user')
                };
                
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                
                console.log('‚úÖ Novo usu√°rio criado no admin:', newUser.name);
                return newUser;
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados do usu√°rio do admin:', error);
            throw error;
        }
    }

    // Carregar dados de progresso espiritual
    loadSpiritualProgressData(userId) {
        try {
            console.log('üôè Carregando dados de progresso espiritual para usu√°rio:', userId);
            
            // Carregar medita√ß√µes personalizadas do usu√°rio
            const personalizedMeditations = this.getPersonalizedMeditationsForUser(userId);
            
            // Carregar medita√ß√µes do admin
            const adminMeditations = JSON.parse(localStorage.getItem('meditations') || '[]');
            
            // Carregar categorias do admin
            const adminCategories = JSON.parse(localStorage.getItem('categories') || '[]');
            
            // Calcular estat√≠sticas gerais
            const personalizedCompleted = personalizedMeditations.filter(m => m.status === 'completed').length;
            const adminCompleted = adminMeditations.filter(m => m.status === 'completed').length;
            const totalCompleted = personalizedCompleted + adminCompleted;
            
            const personalizedInProgress = personalizedMeditations.filter(m => 
                m.status !== 'completed' && m.lastViewed
            ).length;
            const adminInProgress = adminMeditations.filter(m => 
                m.status !== 'completed' && m.lastViewed
            ).length;
            const totalInProgress = personalizedInProgress + adminInProgress;
            
            // Calcular tempo total (estimativa: 15 min por medita√ß√£o)
            const totalMinutes = totalCompleted * 15;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const totalTime = hours > 0 ? `${hours}h ${minutes}min` : `${minutes}min`;
            
            // Calcular dias consecutivos (simplificado)
            const consecutiveDays = Math.min(totalCompleted, 30);
            
            // Processar progresso por categoria
            const categoryProgress = this.calculateCategoryProgress(adminCategories, adminMeditations, personalizedMeditations);
            
            const spiritualProgress = {
                // Estat√≠sticas gerais
                stats: {
                    completedMeditations: totalCompleted,
                    inProgressMeditations: totalInProgress,
                    totalTime: totalTime,
                    consecutiveDays: consecutiveDays,
                    totalMeditations: personalizedMeditations.length + adminMeditations.length
                },
                
                // Progresso por categoria
                categoryProgress: categoryProgress,
                
                // Medita√ß√µes personalizadas
                personalizedMeditations: personalizedMeditations,
                
                // Medita√ß√µes do admin
                adminMeditations: adminMeditations,
                
                // Categorias dispon√≠veis
                categories: adminCategories,
                
                // Hist√≥rico de atividades
                activityHistory: this.getActivityHistory(userId),
                
                // Metas espirituais
                spiritualGoals: this.getSpiritualGoals(userId),
                
                // √öltima atualiza√ß√£o
                lastUpdated: new Date().toISOString()
            };
            
            console.log('‚úÖ Dados de progresso espiritual carregados:', {
                totalCompleted: totalCompleted,
                totalInProgress: totalInProgress,
                totalTime: totalTime,
                categories: categoryProgress.length
            });
            
            return spiritualProgress;
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados de progresso espiritual:', error);
            return {
                stats: {
                    completedMeditations: 0,
                    inProgressMeditations: 0,
                    totalTime: '0min',
                    consecutiveDays: 0,
                    totalMeditations: 0
                },
                categoryProgress: [],
                personalizedMeditations: [],
                adminMeditations: [],
                categories: [],
                activityHistory: [],
                spiritualGoals: [],
                lastUpdated: new Date().toISOString()
            };
        }
    }

    // Obter medita√ß√µes personalizadas do usu√°rio
    getPersonalizedMeditationsForUser(userId) {
        try {
            const allPersonalizedMeditations = JSON.parse(localStorage.getItem('personalized_meditations') || '[]');
            return allPersonalizedMeditations.filter(meditation => meditation.userId === userId);
        } catch (error) {
            console.error('‚ùå Erro ao obter medita√ß√µes personalizadas:', error);
            return [];
        }
    }

    // Calcular progresso por categoria
    calculateCategoryProgress(adminCategories, adminMeditations, personalizedMeditations) {
        try {
            let allCategories = [];
            
            // Processar categorias do admin
            adminCategories.forEach(category => {
                const categoryMeditations = adminMeditations.filter(m => m.categoryId === category.id);
                const completedMeditations = categoryMeditations.filter(m => m.status === 'completed').length;
                const inProgressMeditations = categoryMeditations.filter(m => 
                    m.status === 'in_progress' || m.status === 'pending'
                ).length;
                
                allCategories.push({
                    id: category.id,
                    name: category.name,
                    description: category.description,
                    icon: category.icon || 'üìñ',
                    color: category.color || '#7ee787',
                    total: categoryMeditations.length,
                    completed: completedMeditations,
                    inProgress: inProgressMeditations,
                    percentage: categoryMeditations.length > 0 ? Math.round((completedMeditations / categoryMeditations.length) * 100) : 0,
                    locked: 0
                });
            });
            
            // Processar medita√ß√µes personalizadas
            const personalizedByTopic = {};
            personalizedMeditations.forEach(meditation => {
                const topic = meditation.topic || 'Medita√ß√µes Personalizadas';
                if (!personalizedByTopic[topic]) {
                    personalizedByTopic[topic] = [];
                }
                personalizedByTopic[topic].push(meditation);
            });
            
            Object.entries(personalizedByTopic).forEach(([topic, meditations]) => {
                const completedCount = meditations.filter(m => m.status === 'completed').length;
                const inProgressCount = meditations.filter(m => 
                    m.status === 'in_progress' || m.status === 'pending'
                ).length;
                
                allCategories.push({
                    id: `personalized_${topic}`,
                    name: topic,
                    description: 'Medita√ß√µes personalizadas criadas especialmente para voc√™',
                    icon: '‚ú®',
                    color: '#8b5cf6',
                    total: meditations.length,
                    completed: completedCount,
                    inProgress: inProgressCount,
                    percentage: meditations.length > 0 ? Math.round((completedCount / meditations.length) * 100) : 0,
                    locked: 0
                });
            });
            
            return allCategories;
        } catch (error) {
            console.error('‚ùå Erro ao calcular progresso por categoria:', error);
            return [];
        }
    }

    // Obter hist√≥rico de atividades
    getActivityHistory(userId) {
        try {
            const activityHistory = JSON.parse(localStorage.getItem(`activity_history_${userId}`) || '[]');
            return activityHistory;
        } catch (error) {
            console.error('‚ùå Erro ao obter hist√≥rico de atividades:', error);
            return [];
        }
    }

    // Obter metas espirituais
    getSpiritualGoals(userId) {
        try {
            const spiritualGoals = JSON.parse(localStorage.getItem(`spiritual_goals_${userId}`) || '[]');
            return spiritualGoals;
        } catch (error) {
            console.error('‚ùå Erro ao obter metas espirituais:', error);
            return [];
        }
    }

    // Atualizar dados de progresso espiritual
    updateSpiritualProgress() {
        if (!this.currentUser) {
            console.log('‚ö†Ô∏è Nenhum usu√°rio logado para atualizar progresso');
            return;
        }

        try {
            console.log('üîÑ Atualizando dados de progresso espiritual...');
            
            // Recarregar dados de progresso espiritual
            const updatedProgress = this.loadSpiritualProgressData(this.currentUser.id);
            
            // Atualizar na sess√£o atual
            this.currentUser.spiritualProgress = updatedProgress;
            
            // Salvar na sess√£o
            localStorage.setItem(`session_${this.currentSessionId}`, JSON.stringify(this.currentUser));
            
            // Atualizar estat√≠sticas gerais do usu√°rio
            this.currentUser.stats = {
                consecutiveDays: updatedProgress.stats.consecutiveDays,
                completedMeditations: updatedProgress.stats.completedMeditations,
                totalTime: updatedProgress.stats.totalTime,
                totalMeditations: updatedProgress.stats.totalMeditations,
                inProgressMeditations: updatedProgress.stats.inProgressMeditations
            };
            
            console.log('‚úÖ Progresso espiritual atualizado:', {
                completed: updatedProgress.stats.completedMeditations,
                inProgress: updatedProgress.stats.inProgressMeditations,
                totalTime: updatedProgress.stats.totalTime,
                categories: updatedProgress.categoryProgress.length
            });
            
            return updatedProgress;
            
        } catch (error) {
            console.error('‚ùå Erro ao atualizar progresso espiritual:', error);
            return null;
        }
    }

    // Obter dados de progresso espiritual da sess√£o atual
    getSpiritualProgress() {
        if (!this.currentUser || !this.currentUser.spiritualProgress) {
            console.log('‚ö†Ô∏è Nenhum progresso espiritual dispon√≠vel, atualizando...');
            return this.updateSpiritualProgress();
        }
        return this.currentUser.spiritualProgress;
    }

    // Adicionar atividade ao hist√≥rico
    addActivity(activity) {
        if (!this.currentUser) return;

        try {
            const activityHistory = this.getActivityHistory(this.currentUser.id);
            
            const newActivity = {
                id: 'activity_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                type: activity.type, // 'meditation_completed', 'meditation_started', 'goal_achieved', etc.
                title: activity.title,
                description: activity.description,
                timestamp: new Date().toISOString(),
                metadata: activity.metadata || {}
            };
            
            activityHistory.unshift(newActivity); // Adicionar no in√≠cio
            
            // Manter apenas as √∫ltimas 100 atividades
            if (activityHistory.length > 100) {
                activityHistory.splice(100);
            }
            
            localStorage.setItem(`activity_history_${this.currentUser.id}`, JSON.stringify(activityHistory));
            
            // Atualizar progresso espiritual
            this.updateSpiritualProgress();
            
            console.log('‚úÖ Atividade adicionada ao hist√≥rico:', newActivity.type);
            
        } catch (error) {
            console.error('‚ùå Erro ao adicionar atividade:', error);
        }
    }

    // Definir meta espiritual
    setSpiritualGoal(goal) {
        if (!this.currentUser) return;

        try {
            const spiritualGoals = this.getSpiritualGoals(this.currentUser.id);
            
            const newGoal = {
                id: 'goal_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                title: goal.title,
                description: goal.description,
                type: goal.type, // 'daily_meditation', 'weekly_goal', 'monthly_challenge', etc.
                target: goal.target,
                current: goal.current || 0,
                unit: goal.unit, // 'meditations', 'minutes', 'days', etc.
                createdAt: new Date().toISOString(),
                deadline: goal.deadline,
                completed: false
            };
            
            spiritualGoals.push(newGoal);
            localStorage.setItem(`spiritual_goals_${this.currentUser.id}`, JSON.stringify(spiritualGoals));
            
            console.log('‚úÖ Meta espiritual definida:', newGoal.title);
            
        } catch (error) {
            console.error('‚ùå Erro ao definir meta espiritual:', error);
        }
    }

    // Atualizar progresso de uma meta
    updateGoalProgress(goalId, progress) {
        if (!this.currentUser) return;

        try {
            const spiritualGoals = this.getSpiritualGoals(this.currentUser.id);
            const goalIndex = spiritualGoals.findIndex(goal => goal.id === goalId);
            
            if (goalIndex !== -1) {
                spiritualGoals[goalIndex].current = progress;
                
                // Verificar se a meta foi alcan√ßada
                if (spiritualGoals[goalIndex].current >= spiritualGoals[goalIndex].target) {
                    spiritualGoals[goalIndex].completed = true;
                    spiritualGoals[goalIndex].completedAt = new Date().toISOString();
                    
                    // Adicionar atividade de meta alcan√ßada
                    this.addActivity({
                        type: 'goal_achieved',
                        title: `Meta alcan√ßada: ${spiritualGoals[goalIndex].title}`,
                        description: `Voc√™ alcan√ßou sua meta de ${spiritualGoals[goalIndex].title}`,
                        metadata: { goalId: goalId }
                    });
                }
                
                localStorage.setItem(`spiritual_goals_${this.currentUser.id}`, JSON.stringify(spiritualGoals));
                
                console.log('‚úÖ Progresso da meta atualizado:', spiritualGoals[goalIndex].title);
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao atualizar progresso da meta:', error);
        }
    }

    // Adicionar sess√£o ativa
    addActiveSession(userData) {
        try {
            const activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '[]');
            
            // Remover sess√µes antigas (mais de 24 horas)
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const filteredSessions = activeSessions.filter(session => 
                new Date(session.loginTime) > oneDayAgo
            );
            
            // Adicionar nova sess√£o
            const sessionInfo = {
                sessionId: this.currentSessionId,
                userId: userData.id,
                userName: userData.name,
                userEmail: userData.email,
                loginTime: userData.loginTime,
                lastActivity: userData.lastActivity
            };
            
            filteredSessions.push(sessionInfo);
            localStorage.setItem('activeSessions', JSON.stringify(filteredSessions));
            
            console.log('‚úÖ Sess√£o ativa adicionada:', sessionInfo.userName);
        } catch (error) {
            console.error('‚ùå Erro ao adicionar sess√£o ativa:', error);
        }
    }

    // Remover sess√£o ativa
    removeActiveSession(sessionId) {
        try {
            const activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '[]');
            const filteredSessions = activeSessions.filter(session => session.sessionId !== sessionId);
            localStorage.setItem('activeSessions', JSON.stringify(filteredSessions));
            
            console.log('‚úÖ Sess√£o ativa removida:', sessionId);
        } catch (error) {
            console.error('‚ùå Erro ao remover sess√£o ativa:', error);
        }
    }

    // Obter todas as sess√µes ativas
    getActiveSessions() {
        try {
            return JSON.parse(localStorage.getItem('activeSessions') || '[]');
        } catch (error) {
            console.error('‚ùå Erro ao obter sess√µes ativas:', error);
            return [];
        }
    }

    // Atualizar atividade da sess√£o
    updateActivity() {
        if (this.currentUser) {
            this.currentUser.lastActivity = new Date().toISOString();
            localStorage.setItem(`session_${this.currentSessionId}`, JSON.stringify(this.currentUser));
            
            // Atualizar na lista de sess√µes ativas
            const activeSessions = this.getActiveSessions();
            const sessionIndex = activeSessions.findIndex(s => s.sessionId === this.currentSessionId);
            if (sessionIndex !== -1) {
                activeSessions[sessionIndex].lastActivity = this.currentUser.lastActivity;
                localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
            }
        }
    }

    // Handler para mudan√ßas no localStorage
    handleStorageChange(event) {
        if (event.key === 'activeSessions') {
            console.log('üîÑ Mudan√ßa detectada nas sess√µes ativas');
            // Aqui voc√™ pode implementar l√≥gica para sincronizar com outras abas
        }
    }

    // Limpar sess√µes antigas
    cleanupOldSessions() {
        try {
            const activeSessions = this.getActiveSessions();
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const validSessions = activeSessions.filter(session => 
                new Date(session.loginTime) > oneDayAgo
            );
            
            if (validSessions.length !== activeSessions.length) {
                localStorage.setItem('activeSessions', JSON.stringify(validSessions));
                console.log('üßπ Sess√µes antigas removidas');
            }
        } catch (error) {
            console.error('‚ùå Erro ao limpar sess√µes antigas:', error);
        }
    }
}

// Criar inst√¢ncia global do SessionManager
window.sessionManager = new SessionManager();

// Limpar sess√µes antigas periodicamente
setInterval(() => {
    window.sessionManager.cleanupOldSessions();
}, 60000); // A cada minuto

console.log('‚úÖ SessionManager carregado globalmente'); 